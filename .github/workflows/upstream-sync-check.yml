name: Upstream Sync Check

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6
        with:
          go-version: "1.25.5"
          cache: true
          cache-dependency-path: go.sum

      - name: Configure upstream remote
        run: |
          git remote add upstream https://github.com/obot-platform/obot.git
          git fetch upstream

      - name: Check for new commits
        id: check
        run: |
          COMMITS_BEHIND=$(git rev-list --count HEAD..upstream/main)
          echo "commits_behind=$COMMITS_BEHIND" >> $GITHUB_OUTPUT

          if [ "$COMMITS_BEHIND" -gt 0 ]; then
            echo "âš ï¸ Fork is $COMMITS_BEHIND commits behind upstream"

            # Get latest upstream version
            LATEST_TAG=$(git describe --tags --abbrev=0 upstream/main 2>/dev/null || echo "unknown")
            echo "latest_upstream_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

            # List new commits
            echo "## New Upstream Commits" >> $GITHUB_STEP_SUMMARY
            git log --oneline HEAD..upstream/main >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Fork is up to date with upstream"
          fi

      - name: Test merge feasibility
        id: test_merge
        if: steps.check.outputs.commits_behind != '0'
        run: |
          # Attempt dry-run merge
          if git merge --no-commit --no-ff upstream/main; then
            echo "âœ… Merge appears clean (no conflicts detected)"
            echo "merge_status=clean" >> $GITHUB_OUTPUT
            git merge --abort
          else
            echo "âš ï¸ Merge conflicts detected:"
            echo "merge_status=conflicts" >> $GITHUB_OUTPUT
            git status | grep "both modified" || true
            git merge --abort
            exit 1
          fi

      - name: Run verification script on clean merge
        if: steps.test_merge.outputs.merge_status == 'clean'
        run: |
          echo "### Custom Files Verification" >> $GITHUB_STEP_SUMMARY
          if ./scripts/verify-custom-files.sh >> $GITHUB_STEP_SUMMARY 2>&1; then
            echo "âœ… All custom files verified" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Custom files verification had warnings" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue for manual merge
        if: steps.test_merge.outcome == 'failure'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const commits = '${{ steps.check.outputs.commits_behind }}';
            const tag = '${{ steps.check.outputs.latest_upstream_tag }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âš ï¸ Upstream merge conflicts detected (${commits} commits behind)`,
              body: `Automated check detected conflicts when attempting to merge upstream changes.

              **Upstream Version:** ${tag}
              **Commits Behind:** ${commits}

              **Action Required:**
              Follow the [upstream merge process](docs/docs/contributing/upstream-merge-process.md) to resolve conflicts manually.

              **Quick Start:**
              \`\`\`bash
              git fetch upstream
              git merge --no-commit --no-ff upstream/main
              # Resolve conflicts following documented procedures
              ./scripts/verify-custom-files.sh
              \`\`\`

              **Resources:**
              - [Upstream Merge Process](docs/docs/contributing/upstream-merge-process.md)
              - [Fork Workflow Analysis](docs/docs/contributing/fork-workflow-analysis-2026.md)
              - [Conflict Resolution Matrix](docs/docs/contributing/fork-workflow-analysis-2026.md#appendix-b-conflict-resolution-matrix)

              cc @jrmatherly`,
              labels: ['upstream-sync', 'maintenance']
            });

      - name: Notify on critical updates
        if: steps.check.outputs.commits_behind != '0' && steps.check.outputs.commits_behind > '10'
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          COMMITS=${{ steps.check.outputs.commits_behind }}
          if [ -n "$SLACK_WEBHOOK" ] && [ "$COMMITS" -gt 10 ]; then
            curl -X POST $SLACK_WEBHOOK -H 'Content-Type: application/json' \
              -d "{\"text\":\"ðŸš¨ obot-entraid fork is ${COMMITS} commits behind upstream. Review required: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}"
          fi

      - name: Create success notification
        if: steps.check.outputs.commits_behind != '0' && steps.test_merge.outputs.merge_status == 'clean'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const commits = '${{ steps.check.outputs.commits_behind }}';
            const tag = '${{ steps.check.outputs.latest_upstream_tag }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âœ… Upstream merge ready (${commits} commits available)`,
              body: `Automated check detected new upstream changes that appear to merge cleanly.

              **Upstream Version:** ${tag}
              **Commits Available:** ${commits}

              **Status:** âœ… Test merge successful - no conflicts detected

              **Next Steps:**
              1. Review upstream changes: https://github.com/obot-platform/obot/compare/v${tag.replace('v', '')}...main
              2. Follow merge process: [Upstream Merge Process](docs/docs/contributing/upstream-merge-process.md)
              3. Run verification: \`./scripts/verify-custom-files.sh\`

              **Automated Merge:**
              If you're confident in the changes, you can trigger an automated merge via the [Test Upstream Merge](https://github.com/${{ github.repository }}/actions/workflows/test-upstream-merge.yml) workflow.

              cc @jrmatherly`,
              labels: ['upstream-sync', 'ready-to-merge']
            });
