{{- if eq .Values.config.OBOT_SERVER_MCPRUNTIME_BACKEND "kubernetes" }}
{{- if not (eq .Values.mcpNamespace.create false) }}
apiVersion: v1
kind: Namespace
metadata:
  name: {{ include "obot.config.mcpNamespace" . }}
  {{- with .Values.mcpNamespace.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  labels:
    {{- include "obot.labels" . | nindent 4 }}
{{- end }}
{{- range .Values.mcpImagePullSecrets }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .name }}
  namespace: {{ include "obot.config.mcpNamespace" $ }}
  labels:
    {{- include "obot.labels" . | nindent 4 }}
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: {{ printf "{\"auths\":{\"%s\":{\"username\":\"%s\",\"password\":\"%s\",\"email\":\"%s\",\"auth\":\"%s\"}}}" .registry .username .password .email (printf "%s:%s" .username .password | b64enc) | b64enc }}
{{- end }}

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: {{ include "obot.config.mcpNamespace" . }}
  name: obot-mcp-role
  labels:
    {{- include "obot.labels" . | nindent 4 }}
rules:
  - apiGroups: [""]
    resources: ["secrets", "services"]
    verbs: ["create", "get", "list", "watch", "update", "patch", "delete"]
  - apiGroups: [""]
    resources: ["pods", "pods/log", "events"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["create", "get", "list", "watch", "update", "patch", "delete"]
  # ResourceQuota access for capacity info
  - apiGroups: [""]
    resources: ["resourcequotas"]
    verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  namespace: {{ include "obot.config.mcpNamespace" . }}
  name: obot-mcp-rolebinding
  labels:
    {{- include "obot.labels" . | nindent 4 }}
subjects:
  - kind: ServiceAccount
    name: {{ include "obot.serviceAccountName" . }}
    namespace: {{ .Release.Namespace }}
roleRef:
  kind: Role
  name: obot-mcp-role
  apiGroup: rbac.authorization.k8s.io

---
# ClusterRole to allow obot to create/manage the MCP namespace
# This is needed because obot tries to ensure the namespace exists at startup
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "obot.fullname" . }}-mcp-namespace
  labels:
    {{- include "obot.labels" . | nindent 4 }}
rules:
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["create", "get", "list", "watch"]
    # Limit to only the MCP namespace using resourceNames
  - apiGroups: [""]
    resources: ["namespaces"]
    resourceNames: ["{{ include "obot.config.mcpNamespace" . }}"]
    verbs: ["create", "get", "list", "watch", "update", "patch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "obot.fullname" . }}-mcp-namespace
  labels:
    {{- include "obot.labels" . | nindent 4 }}
subjects:
  - kind: ServiceAccount
    name: {{ include "obot.serviceAccountName" . }}
    namespace: {{ .Release.Namespace }}
roleRef:
  kind: ClusterRole
  name: {{ include "obot.fullname" . }}-mcp-namespace
  apiGroup: rbac.authorization.k8s.io
{{- end }}
