# Microsoft Entra ID Authentication Provider for Obot

This is an authentication provider for [Obot](https://github.com/obot-platform/obot) that enables user authentication using Microsoft Entra ID (formerly Azure Active Directory).

## Features

- **OAuth 2.0 + OIDC**: Secure authentication using OpenID Connect with Azure AD v2.0 endpoints
- **Multi-Tenant Support**: Works with single-tenant, multi-tenant, or organizational accounts
- **Email Domain Restrictions**: Optionally restrict authentication to specific email domains
- **Session Management**: PostgreSQL or cookie-based session storage
- **Token Refresh**: Automatic token refresh for long-lived sessions
- **User Profile Integration**: Extracts user information from ID tokens and Microsoft Graph API
- **Profile Pictures**: Fetches user profile photos from Microsoft Graph
- **Group Support**: Retrieves user's Entra ID group memberships for access control
- **Group Filtering**: Optionally restrict access to specific Azure AD groups
- **Multi-Tenant Filtering**: Restrict access to specific tenant IDs for multi-tenant apps

## Prerequisites

- **Microsoft Entra ID Tenant**: Access to Azure Portal with permission to register applications
- **Obot Server**: Running instance of Obot
- **Go 1.25+**: Required for building from source

## Quick Start

### 1. Register Application in Azure Portal

1. Navigate to [Azure Portal](https://portal.azure.com)
2. Go to **Microsoft Entra ID** → **App registrations** → **New registration**
3. Configure your application:
   - **Name**: `Obot Platform`
   - **Supported account types**: Choose based on your needs:
     - **Single tenant**: Only users in your organization
     - **Multitenant**: Users in any Azure AD organization
     - **Personal Microsoft accounts**: Include personal Microsoft accounts
   - **Redirect URI**:
     - Type: **Web**
     - URL: `https://your-obot-server.com/oauth2/callback`
4. Click **Register**

### 2. Configure Application

After registration, configure the following:

#### API Permissions

1. Go to **API permissions** → **Add a permission**
2. Select **Microsoft Graph** → **Delegated permissions**
3. Add the following permissions:
   - `openid` (Sign users in)
   - `profile` (View users' basic profile)
   - `email` (View users' email address)
   - `offline_access` (Maintain access to data) - for token refresh
4. Click **Add permissions**
5. Click **Grant admin consent** (if you're an admin)

**For Group Support** (optional):
- Add `GroupMember.Read.All` permission to retrieve user's group memberships

#### Client Secret

1. Go to **Certificates & secrets** → **New client secret**
2. Add description: `Obot Auth Provider`
3. Set expiration: **24 months** (or as per your security policy)
4. Click **Add**
5. **Copy the secret value immediately** (you won't see it again!)

#### Gather Configuration Values

From the **Overview** page, copy:
- **Application (client) ID**: `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
- **Directory (tenant) ID**: `yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy`

### 3. Configure Obot

Configure the auth provider in Obot Admin UI or via environment variables:

```bash
# Required
OBOT_ENTRA_AUTH_PROVIDER_CLIENT_ID="<Application (client) ID>"
OBOT_ENTRA_AUTH_PROVIDER_CLIENT_SECRET="<Client secret value>"
OBOT_ENTRA_AUTH_PROVIDER_TENANT_ID="<Directory (tenant) ID>"
OBOT_AUTH_PROVIDER_EMAIL_DOMAINS="*"  # Or "example.com,example.org"

# Optional - Multi-tenant Configuration
# Required when using 'common' or 'organizations' as tenant ID
OBOT_ENTRA_AUTH_PROVIDER_ALLOWED_TENANTS="tenant-id-1,tenant-id-2"

# Optional - Group Filtering
OBOT_ENTRA_AUTH_PROVIDER_ALLOWED_GROUPS="group-id-1,group-id-2"

# Optional - Session Configuration
OBOT_AUTH_PROVIDER_TOKEN_REFRESH_DURATION="1h"  # Token refresh interval

# Auto-provided by Obot
OBOT_SERVER_URL="https://your-obot-server.com"
OBOT_AUTH_PROVIDER_COOKIE_SECRET="<auto-generated>"
OBOT_AUTH_PROVIDER_POSTGRES_CONNECTION_DSN="<auto-provided if using PostgreSQL>"
```

## Configuration Options

### Required Environment Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `OBOT_ENTRA_AUTH_PROVIDER_CLIENT_ID` | Application (client) ID from Azure Portal | `12345678-1234-1234-1234-123456789abc` |
| `OBOT_ENTRA_AUTH_PROVIDER_CLIENT_SECRET` | Client secret value from Azure Portal | `abc123...` |
| `OBOT_ENTRA_AUTH_PROVIDER_TENANT_ID` | Tenant ID or special value (`common`, `organizations`, `consumers`) | `common` |
| `OBOT_AUTH_PROVIDER_EMAIL_DOMAINS` | Allowed email domains (`*` for all, or comma-separated list) | `*` or `example.com` |

### Optional Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `OBOT_AUTH_PROVIDER_TOKEN_REFRESH_DURATION` | `1h` | How often to refresh tokens (format: `1h30m`, `2h`, etc.) |
| `OBOT_ENTRA_AUTH_PROVIDER_ALLOWED_GROUPS` | (empty) | Comma-separated list of Azure AD group IDs allowed to authenticate |
| `OBOT_ENTRA_AUTH_PROVIDER_ALLOWED_TENANTS` | (empty) | Comma-separated list of tenant IDs allowed (required for multi-tenant) |
| `OBOT_ENTRA_AUTH_PROVIDER_GROUP_CACHE_TTL` | `1h` | How long to cache user group memberships (format: `30m`, `2h`, etc.) |
| `OBOT_ENTRA_AUTH_PROVIDER_ICON_CACHE_TTL` | `24h` | How long to cache profile pictures (format: `12h`, `48h`, etc.) |
| `OBOT_AUTH_INSECURE_COOKIES` | `false` | Allow HTTP cookies for local development (**NEVER enable in production**) |
| `OBOT_AUTH_PROVIDER_COOKIE_DOMAIN` | (auto) | Override cookie domain (default: hostname from `OBOT_SERVER_PUBLIC_URL`) |
| `OBOT_AUTH_PROVIDER_COOKIE_PATH` | `/` | Override cookie path |
| `OBOT_AUTH_PROVIDER_COOKIE_SAMESITE` | `Lax` | Override SameSite attribute (options: `Strict`, `Lax`, `None`) |

### Auto-Provided by Obot

These variables are automatically provided by Obot and should not be manually configured:

| Variable | Description |
|----------|-------------|
| `OBOT_SERVER_URL` or `OBOT_SERVER_PUBLIC_URL` | Base URL of your Obot server |
| `OBOT_AUTH_PROVIDER_COOKIE_SECRET` | Base64-encoded secret for cookie encryption (auto-generated) |
| `OBOT_AUTH_PROVIDER_POSTGRES_CONNECTION_DSN` | PostgreSQL connection string (if using database sessions) |
| `PORT` | HTTP server port (default: `9999`) |

## Tenant Configuration Guide

The `OBOT_ENTRA_AUTH_PROVIDER_TENANT_ID` variable controls which Microsoft accounts can authenticate:

### Single Tenant (Recommended for Enterprise)

```bash
OBOT_ENTRA_AUTH_PROVIDER_TENANT_ID="yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy"
```
- Allows: **Only your specific organization**
- Use case: Internal company applications, highest security

### Multi-Tenant with Restrictions

```bash
OBOT_ENTRA_AUTH_PROVIDER_TENANT_ID="organizations"
OBOT_ENTRA_AUTH_PROVIDER_ALLOWED_TENANTS="tenant-id-1,tenant-id-2"
```
- Allows: **Only specified Azure AD organizations**
- Use case: B2B applications with known partners
- **Note**: `ALLOWED_TENANTS` is required when using `common` or `organizations`

### Organizations Only

```bash
OBOT_ENTRA_AUTH_PROVIDER_TENANT_ID="organizations"
OBOT_ENTRA_AUTH_PROVIDER_ALLOWED_TENANTS="*"  # Or specific tenant IDs
```
- Allows: **Any Azure AD organization** (no personal accounts)
- Use case: B2B applications, enterprise software

### Multi-Tenant (All)

```bash
OBOT_ENTRA_AUTH_PROVIDER_TENANT_ID="common"
OBOT_ENTRA_AUTH_PROVIDER_ALLOWED_TENANTS="tenant-id-1,tenant-id-2"
```
- Allows: **Specified Azure AD organizations** + **Personal Microsoft accounts** (if tenant allows)
- Use case: Public SaaS applications with tenant restrictions

## Email Domain Restrictions

Control which email domains can authenticate:

```bash
# Allow all domains
OBOT_AUTH_PROVIDER_EMAIL_DOMAINS="*"

# Allow specific domain
OBOT_AUTH_PROVIDER_EMAIL_DOMAINS="example.com"

# Allow multiple domains
OBOT_AUTH_PROVIDER_EMAIL_DOMAINS="example.com,example.org,example.net"
```

**Note**: This works in combination with tenant restrictions. For example:
- Tenant: `<tenant-id>` + Domains: `*` → Only your org, all email addresses in that org
- Tenant: `organizations` + Domains: `example.com` → Any Azure AD org, but only `@example.com` emails

## Group-Based Access Control

Restrict authentication to users who are members of specific Azure AD groups:

```bash
OBOT_ENTRA_AUTH_PROVIDER_ALLOWED_GROUPS="group-id-1,group-id-2,group-id-3"
```

**Requirements**:
- Add `GroupMember.Read.All` permission to your Azure App Registration
- Grant admin consent for the permission
- Users must be direct or transitive members of at least one specified group

**Note**: Group IDs are UUIDs (e.g., `12345678-1234-1234-1234-123456789abc`), not display names.

## Architecture

This auth provider uses:
- **OAuth2 Proxy**: Industry-standard OAuth 2.0/OIDC implementation (Obot fork)
- **Azure AD v2.0 Endpoints**: Modern OIDC discovery for automatic endpoint configuration
- **JWT Parsing**: Extracts user information from ID tokens
- **Microsoft Graph API**: Fetches user groups and profile pictures

### Session Flow

```
User → Obot → /oauth2/start → Microsoft Login → /oauth2/callback → Session Created → Obot Dashboard
```

1. User clicks "Sign in with Microsoft"
2. Redirected to Microsoft Entra ID login page
3. User authenticates (with MFA if configured)
4. Microsoft redirects back with authorization code
5. Auth provider exchanges code for tokens
6. User information extracted from ID token
7. Groups fetched from Microsoft Graph API (if configured)
8. Session created (PostgreSQL or encrypted cookie)
9. User redirected to Obot dashboard

## Security Features

- **State Parameter**: CSRF protection with random state values
- **Secure Cookies**: `Secure`, `HttpOnly`, `SameSite=Lax` flags automatically configured
- **Token Encryption**: Access tokens encrypted in database/cookies
- **ID Token Validation**: JWT signature verification (via oauth2-proxy) with fail-fast authentication
- **HTTPS Enforcement**: HTTPS required by default, fails on HTTP unless `OBOT_AUTH_INSECURE_COOKIES=true` (development only)
- **Multi-Tenant Validation**: Issuer verification skipped for multi-tenant, but tenant filtering enforced
- **Cookie Configuration**: Domain, path, and SameSite explicitly configured from server URL
- **Token Refresh Error Handling**: Expired sessions redirect to login instead of showing 500 errors
- **Group Description Validation**: Group metadata validated for length and security

## API Endpoints

This auth provider implements the following HTTP endpoints:

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/` | GET | Returns server address |
| `/oauth2/start` | GET | Initiates OAuth flow (accepts `rd` query param for redirect) |
| `/oauth2/callback` | GET | Handles OAuth callback from Microsoft |
| `/oauth2/sign_out` | GET | Signs user out (accepts `rd` query param for redirect) |
| `/obot-get-state` | POST | Returns user session state with groups (used by Obot) |
| `/obot-get-user-info` | GET | Returns user profile from Microsoft Graph |
| `/obot-get-icon-url` | GET | Returns user's profile picture URL |

## Building from Source

```bash
# From the obot-entraid repository root
cd tools/entra-auth-provider

# Build
make build

# Binary will be in: bin/gptscript-go-tool
```

## Development

### Local Testing

1. **Set up environment variables**:
   ```bash
   export OBOT_ENTRA_AUTH_PROVIDER_CLIENT_ID="your-client-id"
   export OBOT_ENTRA_AUTH_PROVIDER_CLIENT_SECRET="your-client-secret"
   export OBOT_ENTRA_AUTH_PROVIDER_TENANT_ID="your-tenant-id"
   export OBOT_SERVER_URL="http://localhost:8080"
   export OBOT_AUTH_PROVIDER_COOKIE_SECRET="$(openssl rand -base64 32)"
   export OBOT_AUTH_PROVIDER_EMAIL_DOMAINS="*"
   export OBOT_AUTH_INSECURE_COOKIES="true"  # Required for HTTP in development
   export PORT="9999"
   ```

2. **Run the auth provider**:
   ```bash
   go run main.go
   ```

3. **Test authentication**:
   - Navigate to: `http://localhost:9999/oauth2/start?rd=http://localhost:8080`
   - Complete Microsoft login
   - Should redirect back to `http://localhost:8080` with session cookie

### Using with Obot Development

When developing Obot locally with this auth provider:

```bash
# In obot-entraid repository
export OBOT_SERVER_TOOL_REGISTRIES="github.com/obot-platform/tools,./tools"
make dev
```

This ensures Obot uses your local auth provider code alongside the upstream tools.

## Troubleshooting

### Error: "AADSTS50011: The redirect URI specified in the request does not match"

**Solution**: Verify redirect URI in Azure Portal matches exactly:
```
https://your-obot-server.com/oauth2/callback
```
**Note**: No trailing slash, HTTPS if in production

### Error: "AADSTS7000218: The request body must contain the following parameter: client_assertion or client_secret"

**Solution**: Check that `OBOT_ENTRA_AUTH_PROVIDER_CLIENT_SECRET` is correctly set and not expired.

### Error: "AADSTS50105: The signed in user is not assigned to a role for the application"

**Solution**: Either:
1. Assign users to the app in Azure Portal → Enterprise Applications
2. Or disable "User assignment required" in app settings

### Error: "Email domain not allowed"

**Solution**: Add user's email domain to `OBOT_AUTH_PROVIDER_EMAIL_DOMAINS` or set to `*`

### Error: "OBOT_ENTRA_AUTH_PROVIDER_ALLOWED_TENANTS is required"

**Solution**: When using `common` or `organizations` as tenant ID, you must specify allowed tenant IDs:
```bash
OBOT_ENTRA_AUTH_PROVIDER_ALLOWED_TENANTS="your-tenant-id-1,your-tenant-id-2"
```

### Session not persisting

**Causes**:
- Cookie security flags require HTTPS in production
- Cookie secret mismatch between restarts
- Session expired

**Solution**:
- Ensure `OBOT_SERVER_URL` starts with `https://` in production
- Use PostgreSQL session storage for persistence across restarts

### Groups not appearing

**Causes**:
- Missing `GroupMember.Read.All` permission
- Admin consent not granted
- Graph API permissions not configured

**Solution**:
1. Add `GroupMember.Read.All` delegated permission in Azure Portal
2. Grant admin consent
3. Re-authenticate to get a new token with the permission

## Advanced Configuration

### Using PostgreSQL for Sessions

For production deployments, use PostgreSQL to persist sessions across server restarts.

Obot automatically provides `OBOT_AUTH_PROVIDER_POSTGRES_CONNECTION_DSN` when configured with a database.

Sessions are stored in tables with the `entra_` prefix.

### Custom Token Refresh Intervals

Balance security and user experience:

```bash
# Refresh tokens every 30 minutes (more secure, more API calls)
OBOT_AUTH_PROVIDER_TOKEN_REFRESH_DURATION="30m"

# Refresh tokens every 2 hours (less secure, fewer API calls)
OBOT_AUTH_PROVIDER_TOKEN_REFRESH_DURATION="2h"
```

### MFA and Conditional Access

Entra ID Conditional Access policies (including MFA) are **automatically enforced**:
- User sees MFA prompts during Microsoft login
- Auth provider doesn't need special configuration
- Works transparently with any Entra ID security policies

## Related Projects

- [Obot Platform](https://github.com/obot-platform/obot) - Open-source MCP Gateway and AI Platform
- [OAuth2 Proxy](https://github.com/obot-platform/oauth2-proxy) - OAuth 2.0 proxy (Obot fork)
- [Obot Tools](https://github.com/obot-platform/tools) - Official auth providers (GitHub, Google)
